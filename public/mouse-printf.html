<!DOCTYPE HTML>
<html>

<head>
  <meta charset="UTF-8">
  <title>Printf Console </title>

  <!-- フォントの読み込み -->
  <link href="https://fonts.googleapis.com/css?family=Inconsolata|Press+Start+2P|Source+Code+Pro" rel="stylesheet">
  <!-- BootstrapのCSS読み込み -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
  <link href="./css/sticky-footer.css" rel="stylesheet">
  <!-- jQuery読み込み -->
  <script src="http://code.jquery.com/jquery-latest.js"></script>
  <!-- BootstrapのJS読み込み -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
  <!-- 各種JS読み込み -->
  <script src="/socket.io/socket.io.js"></script>
  <!-- 文字列操作系関数読み込み-->
  <script type="text/javascript" src="./js/util.js"></script>

  <script type="text/javascript">
    //ヘッダーとフッターの読み込み
    $(function() {
        $("#header").load("header.html");
        $("#footer").load("footer.html");

        //パラメータの読み込み
        var server_ip = "";
        var server_port = "";;
        var message_len = 0;
        $.getJSON("param.json", function(data) {
            server_ip = data.SERVER_ID;
            server_port = data.SERVER_PORT;
            message_len = data.MESSAGE_LEN;
        })
        //printfコンソール用グローバル変数
        var last_msg = "";
        var logno_message = 0;
        var scroll_flag = true;
        //soket.ioの接続
        var s = io.connect('http://' + server_ip + ':' + server_port); //サーバとの接続


        //サーバーから受け取るイベント
        s.on("connect", function() {
          s.emit("C2S:mqtt-sub/query_mqtt_topic", {
            value: "query"
          });
        }); // 接続時
        s.on("disconnect", function(client) {}); // 切断時

        s.on("S2C:mqtt-sub/message", function(data) {
          var data_view = new DataView(data.message);
          var intList = [];
          for (var i = 0; i < message_len; i = i + 1) {
            intList.push(data_view.getUint8(i, true));
          }
          reflectData(intList);
          //console.log(intList);
        });

        s.on("S2C:mqtt-sub/topic_list", function(data) {});

        //クライアントからサーバーへMQTTの購読topic一覧を問い合わせ
        function sendQuery() {
          s.emit("C2S:mqtt-sub/query_mqtt_topic", {
            value: "query"
          })
        }

        //受信したデータを画面に反映
        function reflectData(intList) {
          //console.log("reflectData");
          var sum = 0;
          for (var i = 7; i < message_len; i++) sum += intList[i];
          sum = sum % 256;
          if (sum != intList[6]) {
            console.log("chksum err" + intList[6] + "  " + sum);
            //return;
          }

          //printf関係の処理
          if (intList[7] != 0) {
            msg = "";
            vis_num = 1000;

            function writeLine() {

              $("#printf_list").append("<div class='msg'  >" + "</div>");
              logno_message++;
              var findLines = document.getElementById('printf_list');
              var lines = findLines.children;
              if (logno_message > vis_num - 1) lines[0].remove();
            }

            for (var i = 0; i < intList[7]; i++) {

              if (intList[message_len - 20 + i] == 10) { //10はLFの文字コードです。
                //console.log("LF");
                //console.log(utf8_hex_string_to_string(msg));
                //console.log(msg);
                var findLines = document.getElementById('printf_list');
                var lines = findLines.children;
                console.log(lines.length);
                if (lines.length == 0) {
                  writeLine();
                } else {
                  lines[lines.length - 1].innerText = utf8_hex_string_to_string(last_msg);
                  writeLine();

                  if (scroll_flag == true) $("#printf_list").scrollTop($("#printf_list")[0].scrollHeight);
                }
                msg = "";
                last_msg = "";
              } else {
                msg += intList[message_len - 20 + i].toString(16);
                last_msg += intList[message_len - 20 + i].toString(16);
              }
            }

            var findLines = document.getElementById('printf_list');
            var lines = findLines.children;

            if (lines.length == 0) {
              writeLine();
            } else {
              lines[lines.length - 1].innerText = lines[lines.length - 1].innerText + utf8_hex_string_to_string(msg);
            }

          }
        }//end printf関係の処理

        //printf表示コンソールのスクロールフラグ処理
        function scroll_but_click() {
          console.log("button")
          if (scroll_flag == true) scroll_flag = false;
          else scroll_flag = true;
        }




    })
  </script>

  <style>
    * {
      font-size: 30px;
      margin: 0;
      padding: 0;
    }

    body {
      background-image: url(haikeit.png);
      background-repeat: no-repeat;
      background-size: cover;
    }
  </style>
</head>

<body>

  <!--ヘッダー部分-->
  <div id="header"></div>


  <div class="row">
    <div class="col-md-10 col-md-offset-1">
      <!--見出し-->
      <h1>
        <span style="display:block;padding-left:0.5em;border-left:5px solid #339966;border-bottom:1px solid #339966;"
          onclick="obj=document.getElementById('row_printf').style; obj.display=(obj.display=='none')?'block':'none';
        ">
          <a style="cursor:pointer;">Printf Output Log</a>
        </span>
      </h1>
    </div>
  </div>

  <div class="row" id="row_printf" style="opacity: 0.85;">
    <div class="col-md-10 col-md-offset-1">
      <!-- コンソールっぽい黒い四角 printf出力 -->
      <div class="panel panel-default">
        <div class="panel-heading" style="font-size:large; background-color:rgba(50,50,150,0.5); color:#fff;">
          <b>printf出力ログ ---------- マウスからの文字出力　</b>
          <button id="scroll_but" type="button" style="color:#000;" onclick="scroll_but_click()">
            　自動スクロールON / OFF　
          </button>
        </div>

        <div id="printf_list" style="height:1250px;
                                      overflow:auto;
                                      background-color:rgba(0,0,0,0.75);
                                      color:#FFF;
                                      resize: vertical;
                                      text-shadow: 3px 3px 1px rgba(0,0,0,1.0);
                                      font-family: 'Inconsolata', 'Source Code Pro','ＭＳ ゴシック';
                                      ">
        </div>
      </div>
    </div>
  </div>

</body>

<!--  フッター部分 -->
<div id="footer"></div>

</html>
